#!/bin/bash
cd "$( dirname "${BASH_SOURCE[0]}" )"

#################################################
# Loads the correct module
#
# @param $1: All parameters passed to Originator
#################################################
Originator_dispatch() {
    IFS=':' read -ra segment <<< "$1"
    for part in "${segment[@]}"; do
        module_location="./modules/$part"
        bootstrap_file="$module_location/bootstrap.bash"
        if [ -e "$bootstrap_file" ]; then
            cd "$module_location";
            . "bootstrap.bash"
        else
            Logger__error "Module $part does not exist."
        fi
        break
    done
}

#################################################
# Loads all of the autoload files. Non-recursive
#################################################
Originator__autoload() {
    for file in "$1"/*; do
        if [[ -f "$file" ]]; then
            . "$file"
        fi
    done
}

#################################################
# Start
#################################################
# Loading Libs + Config
Originator__autoload config/default
Originator__autoload lib

# Loading environent specific config
environment_config=config/"$Environment__host"
if [[ -d $environment_config ]] && [[ "$(ls $environment_config)" ]]; then
    Originator__autoload $environment_config
fi

# Dispatching to the specific module
Originator_dispatch "$@"

